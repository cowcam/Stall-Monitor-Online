<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stall Monitor</title>
    <link rel="icon" href="/assets/stallmonitor.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>

    <header class="header">
        <img src="/assets/stallmonitor.png" alt="Stall Monitor Logo">
        <h1>Stall Monitor</h1>
        <div class="user-menu">
            <i class="fas fa-user-circle"></i>
            <div class="dropdown-content">
                <a href="#" id="signin-link">Sign In</a>
                <a href="#" id="signup-link">Sign Up</a>
                <a href="/cancel.html">Unsubscribe</a>
            </div>
        </div>
    </header>

    <div class="hero-container">
        <div class="hero-content">
            <h1>Smarter Calving. Easier Heats.</h1>
            <p class="hero-subtext">Stall Monitor uses 24/7 computer vision analysis to send you instant alerts for calving and heat events. No tags, no collars, no stress.</p>
            <button id="hero-cta-button" class="cta-button">Start Monitoring Now</button>
        </div>
    </div>
    <div class="main-content">

        <section class="feature-grid">
            <div class="feature-item">
                <div class="feature-image">
                    <img src="/assets/calvingalerts.jpg" alt="Calving Alerts">
                </div>
                <div class="feature-description">
                    <h3>Calving Alerts</h3>
                    <p>Healthy calf, healthy cow, peace of mind. Stall Monitor lets you act at the perfect time.</p>
                </div>
            </div>
            <div class="feature-item reverse">
                <div class="feature-image">
                    <img src="/assets/heatalerts.jpg" alt="Heat Alerts">
                </div>
                <div class="feature-description">
                    <h3>Heat Alerts</h3>
                    <p>No neck straps, no bolus, no hassel. Simple, stress-free, and always on watch.</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-image">
                    <img src="/assets/activitygraphs2.jpg" alt="Activity Graphs">
                </div>
                <div class="feature-description">
                    <h3>Activity Graphs</h3>
                    <p>Monitor behavior in real time with hourly and daily activity graphs. More confident timing.</p>
                </div>
            </div>
            <div class="feature-item reverse">
                <div class="feature-image">
                    <img src="/assets/2imagequality.JPG" alt="Image Quality">
                </div>
                <div class="feature-description">
                    <h3>Image Quality</h3>
                    <p>No light? No problem. Stall Monitor can detect a heat even with poor lighting, obstructed view or poor visibility.</p>
                </div>
            </div>
        </section>

    <div id="auth-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="form-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showForm('login')">Sign In</button>
                    <button class="tab-button" onclick="showForm('register')">Sign Up</button>
                </div>

                <div id="login-form-section" class="form-section active">
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-identifier">Email or Farm Name</label>
                            <input type="text" id="login-identifier" required> </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="login-show-password" style="width: auto;">
                            <label for="login-show-password">Show Password</label>
                        </div>
                        <div class="checkbox-group">
                             <input type="checkbox" id="remember-me">
                             <label for="remember-me">Remember Me</label>
                        </div>
                        <button type="submit">Log In</button>
                        <p id="login-message" class="message"></p>
                    </form>
                </div>

                <div id="register-form-section" class="form-section">
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-email">Email Address</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-farm-name">Farm Name</label>
                            <input type="text" id="register-farm-name" required minlength="3" maxlength="50" pattern="[a-zA-Z0-9\s-]+">
                        </div>
                        <div class="form-group">
                            <label for="register-password">Password</label>
                            <input type="password" id="register-password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" required>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-password" style="width: auto;">
                            <label for="show-password">Show Password</label>
                        </div>
                        <button type="submit">Register</button>
                        <p id="register-message" class="message"></p>
                    </form>
                </div>
            </div>
        </div>
    </div>
        <div class="video-container">
           <img id="video-placeholder" src="/assets/collage2.jpg" alt="Stall Monitor Collage" style="width: 100%; border-radius: 12px;">
        </div>
    </div>

    <div id="subscription-modal" class="modal-overlay">
        <div class="modal-container">
            <h2>Almost there!</h2>
            <p>Your account has been created. Click below to activate your Stall Monitor Pro subscription.</p>
            <form id="subscribe-form">
                <button type="submit" id="subscribe-button">Subscribe Now</button>
            </form>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://my-backend.stallmonitor.workers.dev';
        const loginFormSection = document.getElementById('login-form-section');
        const registerFormSection = document.getElementById('register-form-section');
        const tabButtons = document.querySelectorAll('.tab-button');
        let registeredEmail = null; // Still used for Stripe modal

        // --- Check for Remember Me on page load ---
        // --- Check for Remember Me on page load (UPDATED) ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- ADD this check ---
            // If the current path already looks like a farm name, DON'T auto-redirect
            const currentPath = window.location.pathname;
            if (currentPath !== '/' && currentPath !== '/index.html' && currentPath !== '/setup.html' && currentPath !== '/create-farm' /* Add other non-farm root paths if any */) {
                console.log('Already on a potential farm path, skipping auto-redirect check.');
                // Proceed with dashboard loading logic here (if this IS dashboard.html)
            } else {
            // --- END of added check ---

                // Only run the redirect check if we are on a root-level page
                const rememberedUser = localStorage.getItem('stallMonitorRememberedUser');
                if (rememberedUser) {
                    try {
                        const userData = JSON.parse(rememberedUser);
                        if (userData.farmName) {
                            console.log('Remembered user found, redirecting to dashboard...');
                            window.location.href = `/dashboard/${encodeURIComponent(userData.farmName)}`;
                        }
                    } catch (e) {
                        console.error('Error parsing remembered user data:', e);
                        localStorage.removeItem('stallMonitorRememberedUser');
                    }
                }
            } // <-- Close the 'else' block for the path check


        });


        const userMenu = document.querySelector('.user-menu');
        const dropdownContent = document.querySelector('.dropdown-content');

        userMenu.addEventListener('click', (event) => {
            event.stopPropagation();
            dropdownContent.classList.toggle('dropdown-active');
        });

        window.addEventListener('click', (event) => {
            if (!userMenu.contains(event.target)) {
                dropdownContent.classList.remove('dropdown-active');
            }
        });

        const authModal = document.getElementById('auth-modal');
        const signinLink = document.getElementById('signin-link');
        const signupLink = document.getElementById('signup-link');
        
        // --- ADDED FOR HERO BUTTON ---
        const heroCtaButton = document.getElementById('hero-cta-button');

        if (heroCtaButton) {
            heroCtaButton.addEventListener('click', (e) => {
                e.preventDefault();
                showForm('register');
                authModal.style.display = 'flex';
            });
        }
        // --- END HERO BUTTON SCRIPT ---

        signinLink.addEventListener('click', (e) => {
            e.preventDefault();
            showForm('login');
            authModal.style.display = 'flex';
        });

        signupLink.addEventListener('click', (e) => {
            e.preventDefault();
            showForm('register');
            authModal.style.display = 'flex';
        });

        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.style.display = 'none';
            }
        });

        function showForm(formName) { /* Unchanged */
            if (formName === 'login') {
                loginFormSection.classList.add('active'); registerFormSection.classList.remove('active');
                tabButtons[0].classList.add('active'); tabButtons[1].classList.remove('active');
            } else {
                loginFormSection.classList.remove('active'); registerFormSection.classList.add('active');
                tabButtons[0].classList.remove('active'); tabButtons[1].classList.add('active');
            }
        }

        // --- Login Form Logic (UPDATED) ---
        const loginForm = document.getElementById('login-form');
        const loginIdentifierInput = document.getElementById('login-identifier'); // Use new ID
        const loginPasswordInput = document.getElementById('login-password');
        const rememberMeCheckbox = document.getElementById('remember-me'); // Get checkbox
        const loginMessageArea = document.getElementById('login-message');

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            loginMessageArea.textContent = 'Logging in...';
            loginMessageArea.className = 'message';

            const identifier = loginIdentifierInput.value;
            const password = loginPasswordInput.value;
            const rememberMe = rememberMeCheckbox.checked;

            try {
                const response = await fetch(`${WORKER_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier: identifier, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    const farmName = data.farm_name;
                    const userEmail = data.email;

                    if (rememberMe) {
                        const userData = JSON.stringify({ farmName: farmName, email: userEmail });
                        localStorage.setItem('stallMonitorRememberedUser', userData);
                    } else {
                        localStorage.removeItem('stallMonitorRememberedUser');
                    }

                    if (farmName && farmName.trim() !== '') {
                        const encodedFarmName = encodeURIComponent(farmName);
                        const finalUrl = `/dashboard.html?farm=${encodedFarmName}`;
                        window.location.href = finalUrl;
                    } else {
                        window.location.href = '/setup';
                    }
                } else {
                    loginMessageArea.textContent = data.error || 'An unknown error occurred.';
                    loginMessageArea.className = 'message error';
                }
            } catch (error) {
                console.error('Fetch failed:', error);
                loginMessageArea.textContent = 'Could not connect to the server.';
                loginMessageArea.className = 'message error';
            }
        });

        // --- Registration Form Logic (UPDATED) ---
        const registerForm = document.getElementById('register-form');
        const registerEmailInput = document.getElementById('register-email');
        const registerFarmNameInput = document.getElementById('register-farm-name'); // Get farm name input
        const registerPasswordInput = document.getElementById('register-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const showPasswordCheckbox = document.getElementById('show-password');
        const registerMessageArea = document.getElementById('register-message');

        const loginShowPasswordCheckbox = document.getElementById('login-show-password');

        showPasswordCheckbox.addEventListener('change', () => {
            const type = showPasswordCheckbox.checked ? 'text' : 'password';
            registerPasswordInput.type = type;
            confirmPasswordInput.type = type;
        });

        loginShowPasswordCheckbox.addEventListener('change', () => {
            const type = loginShowPasswordCheckbox.checked ? 'text' : 'password';
            loginPasswordInput.type = type;
        });

        registerForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = registerEmailInput.value;
            const farmName = registerFarmNameInput.value; // Get farm name value
            const password = registerPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            registerMessageArea.textContent = 'Registering...';
            registerMessageArea.className = 'message';

            if (password !== confirmPassword) { /* Unchanged */ return; }

             try {
                 const response = await fetch(`${WORKER_URL}/register`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     // Send all three fields
                     body: JSON.stringify({ email: email, password: password, farm_name: farmName })
                 });

                 const data = await response.json();

                 if (response.ok) {
                     // SUCCESS!
                     registeredEmail = data.email; // Save email for Stripe modal
                     // Store BOTH email and farm name for potential later use (e.g., if Stripe fails)
                     localStorage.setItem('stallMonitorUserEmail', data.email);
                     localStorage.setItem('stallMonitorFarmName', data.farm_name);
                     // Show the subscription modal
                     document.getElementById('subscription-modal').style.display = 'flex';
                 } else {
                     // FAILURE (409 Email/Farm Name conflict, etc.)
                     registerMessageArea.textContent = data.error || 'An unknown error occurred.';
                     registerMessageArea.className = 'message error';
                 }
             } catch (error) {
                 console.error('Fetch failed:', error);
                 registerMessageArea.textContent = 'Could not connect to the server.';
                 registerMessageArea.className = 'message error';
             }
        });

        // --- Subscription Modal Logic (Unchanged) ---
        const subscribeForm = document.getElementById('subscribe-form');
        const subscribeButton = document.getElementById('subscribe-button');

        subscribeForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          subscribeButton.textContent = "Redirecting to payment...";
          subscribeButton.disabled = true; // Disable button

          const emailToSubscribe = localStorage.getItem('stallMonitorUserEmail'); // Get email from storage
          const farmNameToSubscribe = localStorage.getItem('stallMonitorFarmName'); // Get farm name from storage

          if (!emailToSubscribe || !farmNameToSubscribe) {
              alert('Error: Could not retrieve user details for subscription. Please try registering again.');
              subscribeButton.textContent = "Subscribe Now";
              subscribeButton.disabled = false;
              return;
          }

          try {
            const response = await fetch(`${WORKER_URL}/api/create-checkout-session`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: emailToSubscribe, farm_name: farmNameToSubscribe }) // Send both email and farm name
            });

            const data = await response.json();

            if (response.ok && data.checkoutUrl) {
              // SUCCESS! Redirect to Stripe
              window.location.href = data.checkoutUrl;
            } else {
              alert('Error creating payment session: ' + (data.error || 'Unknown error'));
              subscribeButton.textContent = "Subscribe Now";
              subscribeButton.disabled = false;
            }
          } catch(e) {
             console.error("Subscription fetch failed:", e);
             alert('Could not connect to the payment server.');
             subscribeButton.textContent = "Subscribe Now";
             subscribeButton.disabled = false;
          }
        });
    </script>
    
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Stall Monitor. All rights reserved.</p>
            <nav class="footer-links">
                <a href="/index.html">Home</a>
                <a href="/cancel.html">Unsubscribe</a>
                </nav>
        </div>
    </footer>
    </body>
</html>